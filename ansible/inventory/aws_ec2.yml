# ==============================================================================
# AWS EC2 DYNAMIC INVENTORY CONFIGURATION
# ==============================================================================
# This file configures Ansible to automatically discover EC2 instances
# Perfect for demonstrating dynamic inventory management in DevOps
# ==============================================================================

plugin: amazon.aws.aws_ec2

# AWS Configuration
regions:
  - us-east-1  # Change to match your Terraform region

# Instance Filters - Only include our managed instances
filters:
  instance-state-name: running
  tag:Project: kudos-app
  tag:ManagedBy: Terraform

# Grouping Strategy
keyed_groups:
  # Group by environment
  - key: tags.Environment
    prefix: env
    separator: '_'
  
  # Group by instance type
  - key: instance_type
    prefix: type
    separator: '_'
  
  # Group by availability zone
  - key: placement.availability_zone
    prefix: az
    separator: '_'
  
  # Group by auto scaling group
  - key: tags.AnsibleGroup
    separator: '_'

# Compose variables for use in playbooks
compose:
  # Ansible connection settings
  ansible_host: public_ip_address
  ansible_user: ec2-user
  
  # Custom variables from instance metadata
  ec2_instance_id: instance_id
  ec2_instance_type: instance_type
  ec2_architecture: architecture
  ec2_placement_az: placement.availability_zone
  ec2_vpc_id: vpc_id
  ec2_subnet_id: subnet_id
  
  # Custom variables from tags
  app_name: tags.Project | default('unknown')
  environment: tags.Environment | default('unknown')
  server_role: tags.AnsibleGroup | default('unknown')
  
  # Derived variables
  short_hostname: tags.Name | regex_replace('.*-(.*)$', '\\1')
  deployment_group: tags.Environment + '_' + tags.AnsibleGroup

# Include/Exclude instances
include_filters: []
exclude_filters:
  - instance-state-name: terminated
  - instance-state-name: stopping
  - instance-state-name: stopped

# Cache settings
cache: True
cache_plugin: memory
cache_timeout: 3600
cache_connection: /tmp/ansible-inventory-cache
cache_prefix: aws_ec2

# Use private IP if no public IP available
hostnames:
  - tag:Name
  - instance-id
  - public-ip-address
  - private-ip-address