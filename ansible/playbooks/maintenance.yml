---
# ==============================================================================
# MAINTENANCE AND MONITORING PLAYBOOK
# ==============================================================================
# This playbook performs routine maintenance and health checks
# Demonstrates operational tasks in traditional server management
# ==============================================================================

- name: "ğŸ”§ Maintenance and Health Checks"
  hosts: webservers
  become: yes
  gather_facts: yes
  
  vars:
    app_name: "kudos-app"
    app_port: 3000
    health_check_url: "http://localhost:{{ app_port }}"
    log_retention_days: 30
    disk_usage_threshold: 80
    memory_threshold: 90

  tasks:
    # System Health Checks
    - name: "ğŸ¥ Check system health"
      block:
        - name: "ğŸ’½ Check disk usage"
          shell: df -h / | tail -1 | awk '{print $5}' | sed 's/%//'
          register: disk_usage
          changed_when: false

        - name: "âš ï¸  Disk usage warning"
          debug:
            msg: "WARNING: Disk usage is {{ disk_usage.stdout }}% (threshold: {{ disk_usage_threshold }}%)"
          when: disk_usage.stdout|int > disk_usage_threshold

        - name: "ğŸ’¾ Check memory usage"
          shell: free | grep Mem | awk '{printf("%.0f", $3/$2 * 100.0)}'
          register: memory_usage
          changed_when: false

        - name: "âš ï¸  Memory usage warning"
          debug:
            msg: "WARNING: Memory usage is {{ memory_usage.stdout }}% (threshold: {{ memory_threshold }}%)"
          when: memory_usage.stdout|int > memory_threshold

        - name: "ğŸŒ¡ï¸  Check CPU load"
          shell: uptime | awk -F'load average:' '{ print $2 }' | awk '{ print $1 }'
          register: cpu_load
          changed_when: false

        - name: "ğŸ“Š System health summary"
          debug:
            msg:
              - "ğŸ’½ Disk Usage: {{ disk_usage.stdout }}%"
              - "ğŸ’¾ Memory Usage: {{ memory_usage.stdout }}%"
              - "ğŸŒ¡ï¸  CPU Load: {{ cpu_load.stdout }}"
      tags: ['health']

    # Application Health Checks
    - name: "ğŸš€ Check application health"
      block:
        - name: "ğŸ” Test application endpoint"
          uri:
            url: "{{ health_check_url }}"
            method: GET
            timeout: 10
          register: app_health
          ignore_errors: yes

        - name: "âœ… Application is healthy"
          debug:
            msg: "Application is responding (Status: {{ app_health.status }})"
          when: app_health.status is defined and app_health.status == 200

        - name: "âŒ Application health issue"
          debug:
            msg: "Application health check failed!"
          when: app_health.failed

        - name: "ğŸ“Š Check PM2 processes"
          shell: sudo -u ec2-user pm2 status
          register: pm2_status
          changed_when: false

        - name: "ğŸ“‹ PM2 process status"
          debug:
            var: pm2_status.stdout_lines
      tags: ['health']

    # Service Status Checks
    - name: "ğŸ”„ Check service status"
      block:
        - name: "ğŸŒ Check Nginx status"
          systemd:
            name: nginx
            state: started
          check_mode: yes
          register: nginx_status

        - name: "ğŸ“Š Nginx service health"
          debug:
            msg: "Nginx is {{ 'running' if nginx_status.changed == false else 'stopped' }}"

        - name: "ğŸ”’ Check fail2ban status"
          systemd:
            name: fail2ban
            state: started
          check_mode: yes
          register: fail2ban_status
          ignore_errors: yes

        - name: "ğŸ›¡ï¸  Fail2ban service health"
          debug:
            msg: "Fail2ban is {{ 'running' if fail2ban_status.changed == false else 'stopped' }}"
          when: fail2ban_status is defined
      tags: ['services']

    # Log Management
    - name: "ğŸ“ Log file management"
      block:
        - name: "ğŸ“ Check log file sizes"
          shell: |
            find /var/log/{{ app_name }}/ -name "*.log" -exec ls -lh {} \; 2>/dev/null || echo "No log files found"
          register: log_sizes
          changed_when: false

        - name: "ğŸ“‹ Log file information"
          debug:
            var: log_sizes.stdout_lines

        - name: "ğŸ§¹ Clean old log files"
          shell: |
            find /var/log/{{ app_name }}/ -name "*.log" -mtime +{{ log_retention_days }} -delete
            find /var/log/nginx/ -name "*{{ app_name }}*.log" -mtime +{{ log_retention_days }} -delete
          register: log_cleanup
          changed_when: log_cleanup.stdout != ""

        - name: "ğŸ“Š Check disk space in /var/log"
          shell: du -sh /var/log/
          register: log_disk_usage
          changed_when: false

        - name: "ğŸ’½ Log directory disk usage"
          debug:
            msg: "Log directory usage: {{ log_disk_usage.stdout }}"
      tags: ['logs']

    # Security Checks
    - name: "ğŸ”’ Security status checks"
      block:
        - name: "ğŸšª Check SSH configuration"
          shell: |
            grep -E "^(Port|PermitRootLogin|PasswordAuthentication)" /etc/ssh/sshd_config
          register: ssh_config
          changed_when: false

        - name: "ğŸ“‹ SSH security settings"
          debug:
            var: ssh_config.stdout_lines

        - name: "ğŸ›¡ï¸  Check fail2ban jail status"
          shell: fail2ban-client status
          register: fail2ban_jails
          changed_when: false
          ignore_errors: yes

        - name: "ğŸ”’ Fail2ban jail status"
          debug:
            var: fail2ban_jails.stdout_lines
          when: fail2ban_jails.rc == 0

        - name: "ğŸ” Check for security updates"
          yum:
            list: updates
            security: yes
          register: security_updates

        - name: "âš ï¸  Security updates available"
          debug:
            msg: "{{ security_updates.results | length }} security updates available"
          when: security_updates.results | length > 0
      tags: ['security']

    # Performance Monitoring
    - name: "âš¡ Performance monitoring"
      block:
        - name: "ğŸ“ˆ Check system load average"
          shell: cat /proc/loadavg
          register: load_avg
          changed_when: false

        - name: "ğŸ’¾ Check memory details"
          shell: cat /proc/meminfo | head -5
          register: mem_info
          changed_when: false

        - name: "ğŸ’½ Check I/O statistics"
          shell: iostat -x 1 1 | tail -n +4
          register: io_stats
          changed_when: false
          ignore_errors: yes

        - name: "ğŸ“Š Performance summary"
          debug:
            msg:
              - "Load Average: {{ load_avg.stdout }}"
              - "Memory Info: {{ mem_info.stdout_lines[0:3] }}"
      tags: ['performance']

    # Backup Verification
    - name: "ğŸ’¾ Backup status"
      block:
        - name: "ğŸ” Check application source backup"
          stat:
            path: "{{ app_directory }}/.git"
          register: git_backup

        - name: "âœ… Git repository status"
          debug:
            msg: "Application source is backed up in Git"
          when: git_backup.stat.exists

        - name: "âŒ No Git backup found"
          debug:
            msg: "WARNING: No Git repository found for application backup"
          when: not git_backup.stat.exists

        - name: "ğŸ“ Check configuration backups"
          find:
            paths: /etc/nginx/
            patterns: "*.conf.backup.*"
          register: config_backups

        - name: "ğŸ“‹ Configuration backup status"
          debug:
            msg: "{{ config_backups.files | length }} configuration backup files found"
      tags: ['backup']

    # Network Connectivity
    - name: "ğŸŒ Network connectivity checks"
      block:
        - name: "ğŸ”Œ Test external connectivity"
          uri:
            url: "https://httpbin.org/get"
            method: GET
            timeout: 10
          register: external_connectivity
          ignore_errors: yes

        - name: "âœ… External connectivity OK"
          debug:
            msg: "External network connectivity is working"
          when: external_connectivity.status is defined and external_connectivity.status == 200

        - name: "âŒ External connectivity issue"
          debug:
            msg: "WARNING: External network connectivity issue detected"
          when: external_connectivity.failed

        - name: "ğŸ” Check listening ports"
          shell: netstat -tuln | grep -E ":80|:{{ app_port }}|:22"
          register: listening_ports
          changed_when: false

        - name: "ğŸ“‹ Active listening ports"
          debug:
            var: listening_ports.stdout_lines
      tags: ['network']

  post_tasks:
    - name: "ğŸ“Š Generate maintenance report"
      template:
        src: templates/maintenance_report.txt.j2
        dest: "/var/log/maintenance_report_{{ ansible_date_time.date }}.txt"
        mode: '0644'
      tags: ['reporting']

    - name: "ğŸ“§ Send status summary"
      debug:
        msg:
          - "ğŸ”§ Maintenance completed at {{ ansible_date_time.iso8601 }}"
          - "ğŸ¥ System Health: {{ 'OK' if disk_usage.stdout|int < disk_usage_threshold else 'WARNING' }}"
          - "ğŸš€ Application: {{ 'Healthy' if app_health.status == 200 else 'Issue Detected' }}"
          - "ğŸ“ Log Management: Completed"
          - "ğŸ”’ Security: Checked"
          - "ğŸ“Š Performance: Monitored"
          - "ğŸ’¾ Backups: Verified"
      tags: ['summary']