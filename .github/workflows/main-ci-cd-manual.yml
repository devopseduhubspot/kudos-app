# =========================================================
# CI/CD Pipeline with KIND Kubernetes Validation
# =========================================================

name: main-ci-cd

on:
  workflow_dispatch:

# ---------------------------------------------------------
# 1. Install Dependencies
# ---------------------------------------------------------
jobs:
  install:
    name: "üì¶ Install Dependencies"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: npm

      - run: npm ci

# ---------------------------------------------------------
# 2. Lint
# ---------------------------------------------------------
  lint:
    name: "üîç Lint"
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: npm
      - run: npm ci
      - run: npm run lint

# ---------------------------------------------------------
# 3. Test
# ---------------------------------------------------------
  test:
    name: "üß™ Test"
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: npm
      - run: npm ci
      - run: npm run test:ci

# ---------------------------------------------------------
# 4. Security Scan
# ---------------------------------------------------------
  security-scan:
    name: "üõ°Ô∏è Security Scan"
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Validate SNYK_TOKEN
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          [ -z "$SNYK_TOKEN" ] && echo "SNYK_TOKEN missing" && exit 1

      - uses: snyk/actions/node@v1
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test

      - uses: snyk/actions/node@v1
        if: always()
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor

# ---------------------------------------------------------
# 5. Build
# ---------------------------------------------------------
  build:
    name: "üèóÔ∏è Build"
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: npm
      - run: npm ci
      - run: npm run build

# ---------------------------------------------------------
# 6. Docker Build & Push
# ---------------------------------------------------------
  docker:
    name: "üê≥ Docker Build & Push"
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-qemu-action@v2
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/kudos-app:latest
            ${{ secrets.DOCKER_USERNAME }}/kudos-app:${{ github.sha }}

# ---------------------------------------------------------
# 7. KIND Kubernetes Deployment + Validation
# ---------------------------------------------------------
  deploy-kind:
    name: "‚ò∏Ô∏è KIND Kubernetes Validation"
    runs-on: ubuntu-latest
    needs: docker

    steps:
      - uses: actions/checkout@v4

      - uses: azure/setup-kubectl@v4
        with:
          version: v1.29.0

      - name: Install KIND
        run: |
          curl -Lo kind https://kind.sigs.k8s.io/dl/v0.22.0/kind-linux-amd64
          chmod +x kind
          sudo mv kind /usr/local/bin/kind

      - name: Create KIND Cluster
        run: kind create cluster --name ci-cluster

      - name: Pull & Retag Image
        run: |
          docker pull ${{ secrets.DOCKER_USERNAME }}/kudos-app:latest
          docker tag ${{ secrets.DOCKER_USERNAME }}/kudos-app:latest kudos-app:dev

      - name: Load Image into KIND
        run: kind load docker-image kudos-app:dev --name ci-cluster

      - name: Deploy Kubernetes Manifests
        run: kubectl apply -k k8s/

      - name: Wait for Deployment
        run: kubectl rollout status deployment/kudos-frontend --timeout=120s

      # ---- ENTRYPOINT VALIDATION ----
      - name: Validate Container Entrypoint
        run: |
          POD=$(kubectl get pods -l app=kudos-frontend -o jsonpath='{.items[0].metadata.name}')
          kubectl exec $POD -- ps aux | grep nginx

      # ---- SERVICE + APP VALIDATION ----
      - name: Port-forward Service
        run: |
          kubectl port-forward svc/kudos-frontend 8080:80 &
          sleep 5

      - name: HTTP Validation
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080)
          if [ "$STATUS" -ne 200 ]; then
            echo "‚ùå App not reachable (HTTP $STATUS)"
            exit 1
          fi
          echo "‚úÖ Kudos app is running (HTTP 200)"

# ---------------------------------------------------------
# 8. Deploy to AWS EC2
# ---------------------------------------------------------
  # deploy-ec2:
  #   name: "üöÄ Deploy to AWS EC2"
  #   runs-on: ubuntu-latest
  #   needs: deploy-kind

  #   steps:
  #     - uses: appleboy/ssh-action@v1
  #       with:
  #         host: ${{ secrets.EC2_HOST }}
  #         username: ${{ secrets.EC2_USER }}
  #         key: ${{ secrets.EC2_SSH_KEY }}
  #         script: |
  #           docker pull ${{ secrets.DOCKER_USERNAME }}/kudos-app:latest
  #           docker stop kudos-app || true
  #           docker rm kudos-app || true
  #           docker run -d --name kudos-app -p 80:80 \
  #             ${{ secrets.DOCKER_USERNAME }}/kudos-app:latest
