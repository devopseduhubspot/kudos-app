# =========================================================
# CI/CD Pipeline with KIND Kubernetes Validation
# =========================================================

name: main-ci-cd-manual

on:
  workflow_dispatch:

# ---------------------------------------------------------
# 1. Install Dependencies
# ---------------------------------------------------------
jobs:
  install:
    name: "üì¶ Install Dependencies"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: npm

      - run: npm ci

# ---------------------------------------------------------
# 2. Lint
# ---------------------------------------------------------
  lint:
    name: "üîç Lint"
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: npm
      - run: npm ci
      - run: npm run lint

# ---------------------------------------------------------
# 3. Test
# ---------------------------------------------------------
  test:
    name: "üß™ Test"
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: npm
      - run: npm ci
      - run: npm run test:ci

# ---------------------------------------------------------
# 4. Security Scan
# ---------------------------------------------------------
  security-scan:
    name: "üõ°Ô∏è Security Scan"
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: "üîÅ Checkout"
        uses: actions/checkout@v4

      - name: "üîê Validate SNYK_TOKEN"
        run: |
          if [ -z "$SNYK_TOKEN" ]; then
            echo "‚ùå SNYK_TOKEN secret is missing"
            exit 1
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: "üîç Snyk Test (Fail on vulnerabilities)"
        uses: snyk/actions/node@v1
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test

      - name: "üìä Snyk Monitor (Send report to dashboard)"
        if: always()
        uses: snyk/actions/node@v1
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor

# ---------------------------------------------------------
# 5. Build
# ---------------------------------------------------------
  build:
    name: "üèóÔ∏è Build"
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: npm
      - run: npm ci
      - run: npm run build

# ---------------------------------------------------------
# 6. Docker Build & Push
# ---------------------------------------------------------
  docker:
    name: "üê≥ Docker Build & Push"
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-qemu-action@v2
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/kudos-app:latest
            ${{ secrets.DOCKER_USERNAME }}/kudos-app:${{ github.sha }}

# ---------------------------------------------------------
# 7. KIND Kubernetes Deployment + Validation
# ---------------------------------------------------------
  deploy-kind:
    name: "‚ò∏Ô∏è KIND Kubernetes Validation"
    runs-on: ubuntu-latest
    needs: docker

    steps:
      - uses: actions/checkout@v4

      - uses: azure/setup-kubectl@v4
        with:
          version: v1.29.0

      - name: Install KIND
        run: |
          curl -Lo kind https://kind.sigs.k8s.io/dl/v0.22.0/kind-linux-amd64
          chmod +x kind
          sudo mv kind /usr/local/bin/kind

      - name: Create KIND Cluster
        run: kind create cluster --name ci-cluster

      - name: Pull & Retag Image
        run: |
          docker pull ${{ secrets.DOCKER_USERNAME }}/kudos-app:latest
          docker tag ${{ secrets.DOCKER_USERNAME }}/kudos-app:latest kudos-app:1.1

      - name: Load Image into KIND
        run: kind load docker-image kudos-app:1.1 --name ci-cluster

      - name: Deploy Kubernetes Manifests
        run: kubectl apply -k k8s/

      - name: Wait for Deployment
        run: kubectl rollout status deployment/kudos-frontend --timeout=120s

      # ---- ENTRYPOINT VALIDATION ----
      - name: Validate Container Entrypoint
        run: |
          POD=$(kubectl get pods -l app=kudos-frontend -o jsonpath='{.items[0].metadata.name}')
          kubectl exec $POD -- ps aux | grep nginx

      # ---- SERVICE + APP VALIDATION ----
      - name: Port-forward Service
        run: |
          kubectl port-forward svc/kudos-frontend 8080:80 &
          sleep 5

      - name: HTTP Validation
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080)
          if [ "$STATUS" -ne 200 ]; then
            echo "‚ùå App not reachable (HTTP $STATUS)"
            exit 1
          fi
          echo "‚úÖ Kudos app is running (HTTP 200)"

# # ---------------------------------------------------------
# # 8. Deploy to AWS EC2 with KIND
# # ---------------------------------------------------------
#   deploy-ec2:
#     name: "üöÄ Deploy to AWS EC2 with KIND"
#     runs-on: ubuntu-latest
#     needs: deploy-kind

#     steps:
#       - uses: actions/checkout@v4

#       - name: "üìÅ Copy k8s manifests to EC2"
#         uses: appleboy/scp-action@v0.1.7
#         with:
#           host: ${{ secrets.EC2_HOST }}
#           username: ${{ secrets.EC2_USER }}
#           key: ${{ secrets.EC2_SSH_KEY }}
#           source: "k8s/"
#           target: "/tmp/kudos-deployment/"
#           strip_components: 0

#       - uses: appleboy/ssh-action@v1
#         with:
#           host: ${{ secrets.EC2_HOST }}
#           username: ${{ secrets.EC2_USER }}
#           key: ${{ secrets.EC2_SSH_KEY }}
#           script: |
#             echo "üîß Installing KIND and dependencies..."
            
#             # Install Docker if not present
#             if ! command -v docker &> /dev/null; then
#               sudo apt-get update
#               sudo apt-get install -y docker.io
#               sudo systemctl start docker
#               sudo systemctl enable docker
#               sudo usermod -aG docker $USER
#             fi
            
#             # Install kubectl if not present
#             if ! command -v kubectl &> /dev/null; then
#               curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
#               sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
#             fi
            
#             # Install KIND if not present
#             if ! command -v kind &> /dev/null; then
#               curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.22.0/kind-linux-amd64
#               chmod +x ./kind
#               sudo mv ./kind /usr/local/bin/kind
#             fi
            
#             echo "üèóÔ∏è Setting up KIND cluster..."
            
#             # Clean up any existing cluster
#             kind delete cluster --name kudos-cluster || true
            
#             # Create new KIND cluster with port mapping for external access
#             cat <<EOF > kind-config.yaml
#             kind: Cluster
#             apiVersion: kind.x-k8s.io/v1alpha4
#             nodes:
#             - role: control-plane
#               extraPortMappings:
#               - containerPort: 30080
#                 hostPort: 80
#                 protocol: TCP
#               - containerPort: 80
#                 hostPort: 8080
#                 protocol: TCP
#             EOF
            
#             kind create cluster --name kudos-cluster --config kind-config.yaml
            
#             echo "üê≥ Pulling and loading Docker image..."
#             docker pull ${{ secrets.DOCKER_USERNAME }}/kudos-app:latest
#             docker tag ${{ secrets.DOCKER_USERNAME }}/kudos-app:latest kudos-app:1.1
#             kind load docker-image kudos-app:1.1 --name kudos-cluster
            
#             echo "‚ò∏Ô∏è Deploying application using k8s manifests..."
            
#             # Navigate to the copied k8s directory
#             cd /tmp/kudos-deployment/k8s
            
#             # Check what manifests are available
#             echo "üìã Available k8s manifests:"
#             ls -la
            
#             # Modify service to use NodePort for external access
#             if [ -f service.yaml ]; then
#               # Create a backup and modify service for external access
#               cp service.yaml service.yaml.backup
#               sed -i 's/type: ClusterIP/type: NodePort/' service.yaml
#               sed -i '/ports:/a\    nodePort: 30080' service.yaml
#               echo "üîÑ Modified service.yaml for external access"
#             fi
            
#             # Deploy using kustomization if available, otherwise apply all manifests
#             if [ -f kustomization.yaml ]; then
#               echo "üì¶ Deploying using kustomization..."
#               kubectl apply -k .
#             else
#               echo "üì¶ Deploying individual manifests..."
#               kubectl apply -f .
#             fi
            
#             echo "‚è≥ Waiting for deployment to be ready..."
#             kubectl rollout status deployment/kudos-frontend --timeout=300s
            
#             echo "üîç Validating deployment..."
#             kubectl get pods -l app=kudos-frontend
#             kubectl get svc kudos-frontend
#             kubectl get ingress || echo "No ingress resources found"
            
#             # Test the application
#             sleep 15
#             echo "üß™ Testing application accessibility..."
            
#             # Try multiple endpoints
#             RESPONSE_80=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80 || echo "000")
#             RESPONSE_8080=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 || echo "000")
            
#             if [ "$RESPONSE_80" -eq 200 ]; then
#               echo "‚úÖ Kudos app is successfully deployed and accessible on port 80!"
#               echo "üåê Access your app at: http://${{ secrets.EC2_HOST }}"
#             elif [ "$RESPONSE_8080" -eq 200 ]; then
#               echo "‚úÖ Kudos app is successfully deployed and accessible on port 8080!"
#               echo "üåê Access your app at: http://${{ secrets.EC2_HOST }}:8080"
#             else
#               echo "‚ö†Ô∏è  App deployed but accessibility test failed (HTTP 80: $RESPONSE_80, HTTP 8080: $RESPONSE_8080)"
#               echo "üîç Debugging information:"
#               kubectl describe svc kudos-frontend
#               kubectl get endpoints
#               echo "üåê Try accessing: http://${{ secrets.EC2_HOST }} or http://${{ secrets.EC2_HOST }}:8080"
#             fi
            
#             # Clean up
#             rm -f kind-config.yaml
